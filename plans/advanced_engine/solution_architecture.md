# 下一代老虎机引擎解决方案 (V3)

## 1. 核心问题分析

### 1.1 关于“重复结果”与“去重”
用户提到的 $16^5$ (约100万) 是**停止位置组合 (Stop Combinations)**。
- **视觉重复**：如果卷轴带上存在重复片段（如 `A, B, C, A, B, C`），不同的停止位置可能产生相同的画面。
- **结果重复**：绝大多数组合（约 80%-90%）都是“未中奖”或“极小奖”。
- **结论**：目前的“全量存储”方案确实浪费了大量内存来存储重复的“未中奖”数据。
- **优化思路**：**不要存储“未中奖”和“低倍项”**。这些结果概率极高，**实时随机生成**即可（Rejection Sampling）。只存储或构造“高倍稀有项”。

### 1.2 关于“高倍率图形条件生成” (Reverse Engineering)
与其随机撞大奖（效率极低），不如**反向构造**。
- **正向**：随机停止位置 -> 算倍数 -> 只有 0.001% 是大奖。
- **反向**：设定目标“5个Wild” -> 查找/计算能产生该画面的停止位置 -> 直接返回。
- 这就是 **"Pattern Injection" (模式注入)** 技术。

### 1.3 关于“动态卷轴”与“不规则窗口”
- **Megaways / 动态行高**：每列行数在 2-7 之间随机变化。
- **异形窗口**：如 3-4-5-4-3 结构。
- **Ways 玩法**：不再基于“线 (Lines)”，而是基于“相邻列存在相同符号”。
- **解决方案**：放弃固定的二维数组矩阵，改用 **列对象 (Column Objects)** 模型，配合 **深度优先搜索 (DFS)** 或 **乘法原理** 计算中奖。

---

## 2. 解决方案架构

### 2.1 混合生成引擎 (Hybrid Engine)

引擎不再单一依赖“查表”，而是根据目标 RTP 和波动性，动态选择生成策略：

| 目标结果 | 生成策略 | 适用场景 |
| :--- | :--- | :--- |
| **未中奖 / 小奖** | **实时拒绝采样 (Rejection Sampling)** | 概率高 (>1%)，随机生成几次就能命中。无需内存。 |
| **中奖 (中倍率)** | **智能筛选 (Smart Filtering)** | 在卷轴中预先标记“高价值区域”，只在这些区域附近随机。 |
| **大奖 / 特殊奖** | **模式注入 (Pattern Injection)** | 直接从预设的“完美牌型库”中读取停止位置，或通过算法强制替换符号。 |

### 2.2 动态 Ways 算法
对于 Megaways 或异形卷轴，使用如下算法计算中奖：
1.  **布局生成**：先随机生成每列的高度 `[h1, h2, h3, h4, h5]`。
2.  **符号填充**：根据高度截取卷轴符号。
3.  **Ways 计算**：
    -   统计每列中各符号的数量。
    -   从左到右，如果符号连续出现，则 `Ways = Count(Col1) * Count(Col2) * ...`
    -   `Total Win = Ways * Symbol_Odds * Bet_Per_Way`

---

## 3. 目录结构与代码演示

在 `plans/advanced_engine/` 目录下，我们将包含以下文件：

1.  `solution_architecture.md`: 本文档。
2.  `prototype_dynamic_reels.py`: **核心原型代码**。包含：
    -   支持动态行高 (Dynamic Rows) 的数据结构。
    -   支持 Ways (路单) 判定的算法。
    -   演示“拒绝采样”生成普通结果。
    -   演示“强制构造”生成大奖结果。

---

## 4. 实施建议

1.  **保留 V2 引擎**用于标准 3x5 游戏，因其稳定且已优化。
2.  **开发 V3 引擎**用于“创新玩法”（Megaways, 级联消除等）。
3.  **工具链升级**：需要开发一个“牌型编辑器”，让策划可以直接在界面上摆放符号，生成“大奖种子 (Seeds)”，而不是靠程序去跑。
