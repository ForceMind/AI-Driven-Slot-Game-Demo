# Slot Master Pro: 数值引擎 (OutcomeEngine) 技术文档

本文档旨在详细说明 `OutcomeEngine` 的核心逻辑、数学模型以及安全控制机制。该引擎负责老虎机的所有数值判定，确保游戏在符合预期 RTP（玩家回报率）的同时，具备良好的心理反馈。

---

## 1. 核心架构：预计算与奖池系统 (Bucket System)

为了实现毫秒级的响应速度并精确控制中奖分布，引擎采用了**空间预计算**技术。

### 1.1 状态空间遍历
在引擎初始化时，它会遍历（或采样）卷轴组合的所有可能结果（$16^5 = 1,048,576$ 种组合）。对于每种组合，引擎会计算其：
- **中奖倍数 (Multiplier)**：基于赔率表和中奖线。
- **特殊状态**：是否触发 Near Miss（差一点中奖）。

### 1.2 奖池分类 (Bucketing)
计算出的结果被归类到不同的“奖池”中：
- `Loss_Random`: 0 倍收益。
- `Loss_NearMiss`: 0 倍收益，但视觉上看起来接近中奖（如 2 个 Scatter）。
- `Win_Tier_1` 至 `Win_Tier_5`: 按倍数区间划分（如 Tier 1 为 0.1-5倍，Tier 5 为 50倍以上）。

---

## 2. 判定逻辑：PRD 算法与权重控制

当玩家点击旋转时，引擎通过以下步骤决定最终结果：

### 2.1 PRD (Proportional Random Distribution) 判定
引擎首先决定本次旋转是“中奖”还是“未中奖”。
- **公式**：$P(win) = base\_c \times (fail\_streak + 1)$
- **逻辑**：`fail_streak` 是玩家连续未中奖的次数。随着连输次数增加，中奖概率线性上升。这保证了玩家不会遭遇极端的长连输，提供了心理补偿。
- **分流**：
    - 如果判定为 **Win**：后续只从 `Win_Tier` 奖池中抽取。
    - 如果判定为 **Loss**：后续只从 `Loss_` 奖池中抽取。

### 2.2 权重过滤 (Filtering)
在选定 Win/Loss 分支后，引擎会根据以下规则进一步过滤可用奖池：

1.  **进度分层 (Progress Tiers)**：
    - 根据 `total_spins`（总旋转数）限制奖池。例如，在游戏前 10 次旋转中，可能禁止出现 `Win_Tier_5`，以防止新玩家瞬间爆奖后流失。
2.  **高额投注检查 (High Roller Check)**：
    - 如果 `bet`（下注额）低于阈值（默认 50），则自动禁用最高等级的奖池（Tier 4 & 5）。这鼓励玩家提高下注额以解锁更高奖励。

---

## 3. 安全机制：盈利天花板 (Safety Ceiling)

这是系统最关键的风险控制逻辑，用于防止系统性亏损或数值失控。

### 3.1 最大余额倍数 (Max Win Ratio)
- **核心公式**：$MaxAllowedBalance = InitialBalance \times max\_win\_ratio$
- **逻辑**：系统会检查“如果本次中奖，玩家的余额是否会超过天花板”。
- **执行过程**：
    1.  随机选定一个奖池（如 `Win_Tier_3`）。
    2.  计算该奖池的最大潜在奖金：$PotentialWin = MaxMultiplier_{bucket} \times Bet$。
    3.  **判定**：如果 $CurrentBalance + PotentialWin > MaxAllowedBalance$，则认为该奖池具有“风险”。
    4.  **处理**：系统会**丢弃**该奖池，并尝试在更低倍数的奖池中重新抽取。如果所有中奖奖池都超标，则强制转为 `Loss_Random`。

### 3.2 对 RTP 的影响
- **理论 RTP**：由配置文件中的原始权重决定。
- **实际 RTP**：由于“安全天花板”的存在，实际 RTP 通常会略低于理论值。
- **模拟器提示**：在进行快速模拟时，如果设置的 `initial_balance` 过低，会频繁触发此安全逻辑，导致大奖被过滤，从而使模拟出的 RTP 远低于预期。

---

## 4. 总结：RTP 是如何被控制的？

1.  **下限保障**：通过 PRD 算法和 `fail_streak` 补偿，确保玩家在运气极差时能获得保底中奖，维持活跃度。
2.  **上限控制**：通过 `max_win_ratio` 强制削减高倍率中奖，确保系统不会因为单次极端大奖而导致整体 RTP 爆表。
3.  **动态平衡**：系统通过调整 `base_c_value`（基础中奖率）和奖池权重，在“让玩家爽”和“系统盈利”之间寻找平衡点。

---

## 5. 系统集成与会话管理 (Session Management)

除了核心数值引擎，后端还通过 `app.py` 实现了多用户隔离逻辑：

### 5.1 会话隔离
- **机制**：使用 `X-Session-ID` 请求头识别用户。
- **存储**：在内存中为每个 Session 维护独立的 `OutcomeEngine` 实例和 `SessionData`。
- **独立性**：每个标签页（Session）拥有独立的余额、历史记录和 PRD 状态（连输计数）。

### 5.2 模拟器逻辑 (Simulation Mode)
- **原理**：模拟器直接调用 `OutcomeEngine.spin`，但会传入 `simulation_mode=True`。
- **本金模拟**：为了准确模拟 RTP，模拟器会自动计算一个“虚拟本金”（通常为 `旋转次数 * 下注额`），以确保不会因为余额不足而触发安全天花板过滤掉大奖。

---

## 6. 流程图 (逻辑顺序)

1.  **输入**：下注额、当前余额、初始余额、连输次数、总旋转数。
2.  **PRD 抽签**：决定是 Win 还是 Loss。
3.  **初步过滤**：根据下注额和旋转数剔除不合格奖池。
4.  **安全校验**：检查选定奖池是否会突破 `MaxAllowedBalance`。
5.  **结果输出**：返回矩阵、奖金、更新后的连输计数。
