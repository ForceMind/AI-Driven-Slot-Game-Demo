# 后端算法与数值处理逻辑说明

## 1. 图形配置中的基础价值（base_value）是什么？

在 `game_config_v2.json` 的 `symbols` 字段中，每个符号（如 H1、L1、L2 等）都包含一个 `base_value`，例如：
```json
"H1": { "id": "H1", "name": "Diamond", "type": "standard", "base_value": 50 }
```
**含义：**
- `base_value` 代表该符号的“基础分值”或“理论价值”，用于设计和调试阶段衡量符号稀有度和奖池分布。
- 实际中奖金额由 `pay_table` 决定，`base_value` 主要用于策划参考，不直接参与中奖金额计算。

## 2. 后端完整算法逻辑（OutcomeEngine）

### 2.1 配置加载
- 读取 `game_config_v2.json`，加载：
  - 符号表（symbols）、赔率表（pay_table）、中奖线（lines）、转轴（reel_sets）、分桶（buckets）、参数（settings）等。

### 2.2 预处理：分桶初始化
- 遍历所有可能的转轴停点组合（或采样），对每种组合：
  1. 生成 3x5 的符号矩阵。
  2. 计算所有中奖线的中奖情况，统计每条线的最大连线数和符号。
  3. 按中奖倍数归类到不同的“分桶”（buckets），如 Loss_Random、Win_Tier_1 等。

### 2.3 单次 spin 流程
1. **输入参数**：
   - 当前下注额（bet）、余额、初始余额、历史RTP、总旋转数等。
2. **分桶选择**：
   - 进度分层（progress_tiers）：根据总旋转数，限制可用分桶。
   - 高额下注门槛（high_roller_threshold）：低于门槛时禁用高额分桶。
   - RTP安全阈值（max_win_ratio）：如果当前余额+最大可能中奖>初始余额*阈值，则禁止高额分桶。
   - 按权重加权随机选择分桶。
3. **结果生成**：
   - 从分桶中随机抽取一个停点，生成 3x5 矩阵。
   - 计算所有中奖线，统计中奖倍数、中奖符号、中奖格子。
   - 中奖金额 = 中奖倍数 × 当前下注。
   - 返回中奖矩阵、中奖线、中奖金额、分桶类型、余额变动等。

### 2.4 中奖判定与数值处理
- **中奖线判定**：
  - 每条线从左到右，遇到第一个非WILD符号后，连续相同符号（或WILD）达到3个及以上即为中奖。
  - 中奖倍数查 `pay_table`，如 H1 连3个，倍数为5。
- **中奖金额**：
  - 单条线中奖金额 = 赔率 × 下注。
  - 总中奖金额 = 所有中奖线中奖金额之和。
- **分桶归类**：
  - 中奖倍数落在哪个区间（如5~10倍），归入对应分桶（如 Win_Tier_2）。
- **余额变动**：
  - 余额变动 = 总中奖金额 - 下注。

### 2.5 其他机制
- **Near Miss**：若出现2个SCATTER或4连不中，归为 Loss_NearMiss。
- **RTP调控**：通过调整分桶权重和分层策略，长期RTP趋近于 `target_rtp`。

---

## 3. 主要数值处理逻辑总结
- **所有中奖金额、RTP、净利润等，均基于下注和赔率表动态计算。**
- **分桶权重、进度分层、RTP安全阈值等，决定了长期RTP和玩家体验。**
- **基础价值（base_value）仅为策划参考，实际中奖金额以 pay_table 为准。**

---

如需详细代码注释或流程图，可进一步补充。