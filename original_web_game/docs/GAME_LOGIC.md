# 老虎机游戏逻辑与架构

## 1. 核心架构
游戏采用**伪随机分布 (PRD)** 模型结合**预计算桶**，以确保性能、RTP 控制和公平性。

### 1.1 游戏引擎 (`backend/engine.py`)
游戏引擎是系统的核心。它不会为每次旋转实时生成结果。相反，它会预先计算所有可能的转轴组合（或其大部分子集），并根据其赔付金额将它们分类到不同的“桶”中。

**初始化过程：**
1.  **加载配置**：读取 `config.json` 文件，获取符号、转轴、赔付线和赔付表信息。
2.  **生成状态空间**：遍历所有转轴停止位置组合（例如，16^5 种组合）。
3.  **计算赔付**：对于每种组合，计算总赢额。
4.  **桶分类**：
*   **亏损**：赔付 = 0
*   **小赢**：0.1 倍 - 2 倍下注额
*   **中赢**：2 倍 - 5 倍下注额
*   **大赢**：5 倍 - 10 倍下注额
*   **巨赢**：10 倍 - 20 倍下注额
*   **超级巨赢**：20 倍以上下注额
5.  **存储**：将有效的停止位置组合存储在内存列表 (`self.buckets`) 中。

---

## 2. RTP 控制与赢奖逻辑

### 2.1 旋转循环
当用户旋转时：
1.  **PRD 检查**：确定用户*是否*应该赢，而不是*赢什么*。 
*   `prob = base_c * (fail_streak + 1)`
*   随着 `fail_streak`（连续失败次数）的增加，触发赢奖的概率也会增加。 
*   这可以防止长时间的连败，同时保持随机性。

2.  **动态补偿 (RTP 保障)**：
*   引擎检查用户当前的 RTP（`总赢额 / 总下注额`）。 
*   **如果 RTP < 目标值（运气不佳）**：提高赢奖概率（例如，1.2 倍或 2.0 倍）。 *   **如果 RTP > 目标值（幸运）**：降低获胜概率（例如，0.8 倍）。 
*   这确保实际 RTP 随着时间的推移趋近于 `target_rtp`。

3.  **奖池选择**：
*   如果触发了中奖，引擎会选择一个“奖池”（例如，小奖、中奖、大奖等）。 
*   选择是根据 `config.buckets` 中的权重加权进行的。 
*   **约束检查**：
*   **阈值**：某些奖池（例如，大奖/巨奖）需要达到最低 `total_wagered` 金额才能解锁。 
*   **最大赢取比例**：检查潜在奖金是否会超过 `initial_balance * max_win_ratio`。如果超过，则拒绝该奖池，以防止赌场资金耗尽。

4.  **结果生成**：
*   选择奖池后，会从该奖池中随机抽取一个卷轴停止组合。 
*   将矩阵和中奖线返回给前端。

### 2.2 C 值计算与中奖率 (PRD 详解)

**C 值 (Base C)** 是伪随机分布 (Pseudo-Random Distribution) 算法的核心常数。它决定了“第一次旋转就中奖”的基础概率，以及随着连败次数增加，中奖概率提升的速度。

**公式:**
$$ P(N) = C \times N $$
其中 $P(N)$ 是在第 $N$ 次旋转（即已经连败了 $N-1$ 次）时中奖的概率。

**C 值与中奖率的关系:**
虽然 PRD 算法比较复杂，但我们可以用一个近似公式来描述 C 值与实际中奖率 (Win Rate) 的关系：
$$ \text{Win Rate} \approx \sqrt{2C} $$
或者反过来：
$$ C \approx \frac{(\text{Win Rate})^2}{2} $$
*(注：这是一个粗略的近似，实际值会因最大连败截断等因素略有不同，通常需要通过模拟校准)*

**C 值参考表 (近似值):**

| 期望中奖率 (Win Rate) | 推荐 C 值 (Base C) | 说明 |
| :--- | :--- | :--- |
| **10%** (0.10) | **0.004** | 极低频中奖，适合高波动性游戏 (大奖多) |
| **20%** (0.20) | **0.018** | 低频中奖 |
| **30%** (0.30) | **0.045** | 中等频率 |
| **40%** (0.40) | **0.085** | 较高频率 |
| **50%** (0.50) | **0.140** | 高频中奖，适合休闲游戏 (小奖多) |
| **60%** (0.60) | **0.210** | 极高频中奖 |

*在配置界面中，您可以点击 "Auto Tune" 让系统根据目标 RTP 自动计算最佳的 C 值。*

### 2.3 校准
`calibrate(target_rtp)` 函数计算理想的 `base_c_value`。
*   公式：`Required_Win_Prob = Target_RTP / Avg_Win_Multiplier`
*   它运行二分查找模拟来找到产生 `Required_Win_Prob` 的 `base_c` 值。

---

## 3. 配置 (`config.json`)

### 3.1 设置
*   `target_rtp`：期望的玩家回报率（例如，0.97 表示 97%）。
*   `base_c_value`：PRD 的基本概率常数。
*   `max_win_ratio`：安全上限。允许的最大余额 = `initial_balance * max_win_ratio`。

### 3.2 奖池
定义中奖等级。
*   `min`/`max`：赔付范围（投注额的倍数）。
*   `weight`：选择的概率权重。
*   `threshold`：触发此奖池所需的最低投注金额。

### 3.3 赔付表
定义符号匹配的赔付。 *   格式：`符号 -> 匹配次数 -> 倍数`
*   示例：`H1（钻石）-> 5 次匹配 -> 50 倍`

---

## 4. 模拟
`/simulate` 端点会以紧凑的循环方式运行游戏逻辑（例如 1000 次旋转），以验证 RTP（玩家回报率）和余额曲线。
*   **自动充值**：如果模拟过程中余额耗尽，系统会自动充值以继续收集数据，直到完成全部 `n_spins` 次旋转。
*   **历史记录**：记录一段时间内的余额和 RTP 数据，以便进行可视化分析。